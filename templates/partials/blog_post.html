<article class="content blog-post">
  <header>
    <h1>{{ blogPost.Title }}</h1>
    {% include './blog_post_meta.html' %}
  </header>

  {% if loggedIn %}
    <div>
      <a href="/blog/{{ blogPost.Slug }}/edit" class="btn btn-gray btn-small">Edit</a>
      {% include './publish_link.html' %}
      {% include './unlist_link.html' %}
      {% include './delete_link.html' %}
    </div>
  {% endif %}

  {% if blogPost.Tags | contains:"tutorial" and blogPost.Date | isodatenewerdays:365 %}
    <p class="notice notice--warning">
      This post was published on <code>{{ blogPost.Date | isoformat }}</code> and may be out of date
    </p>
  {% endif %}

  {{ blogPost.Content | markdown }}
</article>

<div class="row-spaced">
  <div class="clap-button">
    <button {{ blogPost.Published | yesno:",disabled" }}>{{ 'images/icons/cheers.svg' | inlineStatic | safe }}</button>
    <div title="{{ blogPost.VotesUsers }} readers">
      <span class="clap-count">{{ blogPost.VotesTotal | default:"Be the first to" }}</span> cheers
    </div>
  </div>
  {% include './blog_post_tag.html' with tags=blogPost.Tags %}
</div>
<div class="expose-on-clap" data-votes="50">
  <div class="notice notice--danger">
    Oops! It seems like you used up all your votes âœ‹ğŸ»
  </div>
</div>
<div class="expose-on-clap" data-votes="25">
  <div class="notice notice--warning">
    Okay, that's enough. You're too kind ğŸ˜„
  </div>
</div>
<div class="expose-on-clap" data-votes="14">
  <div class="notice notice--notice">
    Woah, thanks for the love! â¤ï¸
  </div>
</div>
<div class="expose-on-clap" data-votes="8">
  <div class="notice notice--info">
    Still here? Please consider sharing this post on Hacker News, Reddit, or Twitter ğŸ”¥
  </div>
</div>
<div class="expose-on-clap" data-votes="1">
  <div class="notice notice--subtle">
    Thanks, I'm glad you enjoyed it! ğŸ˜ƒ
  </div>
</div>

<hr class="hr--spaced">
<div>
  <div class="row-spaced">
    <h2 class="row-spaced">More Posts âœğŸ»</h2>
    <small><a href="/blog" title="See all blog posts">See All &raquo;</a></small>
  </div>
  {% include './post-cards.html' with blogPosts=recommendedBlogPosts %}
</div>

{% include './full-subscription-form.html' %}

{% block extraScripts %}
  <script>
    (function () {
      const body = document.body;
      const el = body.querySelector('.clap-button');
      const showOnCheers = body.querySelectorAll('.expose-on-clap');
      const lbl = el.querySelector('.clap-count');
      const btn = el.querySelector('button');
      const lsKey = 'vote-{{ blogPost.Slug }}';

      const updateDisabled = function () {
        const count = JSON.parse(localStorage.getItem(lsKey)) || 0;
        if (count >= 50) {
          btn.setAttribute('disabled', 'disabled');
        }
      };

      updateDisabled();

      btn.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        let count = parseInt(localStorage.getItem(lsKey)) || 0;
        count = isNaN(count) ? 0 : count;

        fetch('/api/blog/vote', {
          method: 'POST',
          body: `slug={{ blogPost.Slug }}&count=${count}`,
          headers: {
            [body.getAttribute('data-csrf-token-header')]: body.getAttribute('data-csrf-token'),
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        }).then(resp => resp.text()).then(function (total) {
          localStorage.setItem(lsKey, JSON.stringify(count + 1));

          el.setAttribute('data-total', total);
          updateDisabled();
          lbl.innerHTML = total;
          for (const el of showOnCheers) {
            if (count + 1  >= parseInt(el.getAttribute('data-votes'))) {
              el.className += ' expose-on-clap--show';

              // Only show one at a time
              break;
            }
          }
        });
      });
    })();
  </script>
{% endblock %}
