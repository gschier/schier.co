{% extends '../../layouts/base.html' %}

{% block content %}
  <div id="editor-app">
    <h1 class="mb-6">Edit Post</h1>
    <form action="/forms/blog/upsert" method="post" id="edit-form">
      {{ csrfField | safe }}
      {% include '../../partials/form-input.html' with type='hidden' name='id' value=blogPost.ID required=true %}
      {% include '../../partials/form-input.html' with type='hidden' name='date' value=blogPost.Date required=true %}
      {% include '../../partials/form-input.html' with label='Slug' type='text' name='slug' value=blogPost.Slug placeholder='my-blog-post' autofocus=true required=true %}
      {% include '../../partials/form-input.html' with label='Title' type='text' name='title' value=blogPost.Title placeholder='My Blog Post' required=true %}
      {% include '../../partials/form-input.html' with label='Tags' type='text' name='tags' value=blogPost.Tags placeholder='Tag1, Tag2' %}

      <div class="form-row">
        <div class="flex">
          <label for="content">Content</label>
          <button v-on:click="toggleExpand" type="button" class="ml-auto pl-4 pb-1 opacity-50 hover:opacity-100">
            <i class="fa fa-expand"></i>
          </button>
        </div>
        <textarea
                required
                name="content"
                id="content"
                rows="10"
                @input="onContentChange"
        >{{ blogPost.Content }}</textarea>
      </div>

      <!-- Blog Post Editor -->
      <div class="blog-post-editor" v-bind:class="{ hidden: hideContentEditor }" v-cloak>
        <div class="blog-post-editor__edit">
          <div class="flex pb-4">
            <h1 class="text-xl">Edit Contents</h1>
            <button
                    class="btn btn--small bg-gray-200 hover:bg-gray-300 text-gray-500 ml-auto py-2 px-3"
                    type="button"
                    v-on:click="toggleExpand"
            >
              <i class="fa fa-times"></i>
            </button>
          </div>
          <div id="editor">Editor here...</div>
        </div>
        <div class="blog-post-editor__preview">
          <!-- Will be filled by script -->
        </div>
      </div>
      <!-- / Blog Post Editor -->

      <div class="flex">
        <button class="ml-auto btn">
          {% if blogPost %}Update{% else %}Create{% endif %}
        </button>
      </div>
    </form>
  </div>
{% endblock %}

{% block extraScripts %}
  <script>
    new schier.Vue({
      el: '#editor-app',
      data: {
        previewCount: 0,
        hideContentEditor: true,
        cm: null,
      },
      methods: {
        onContentChange: function (e) {
          const validity = e.target.value.includes('<!--more-->') ? '' : 'Missing <!--more--> tag';
          e.target.setCustomValidity(validity);

        },
        toggleExpand: function () {
          this.hideContentEditor = !this.hideContentEditor;

          let debounceTimeout = 0;
          const update = (debounceMillis = 0) => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(async () => {
              const p = document.querySelector('.blog-post-editor__preview');
              if (!p.hasChildNodes()) {
                for (let i = 0; i < 2; i++) {
                  const f = document.createElement('iframe');
                  f.id = `preview-frame-${i}`;
                  f.style.display = 'none';
                  p.appendChild(f);
                }
              }

              // Swap between two i-frames to prevent loading flicker
              const oldPreviewEl = document.querySelector('#preview-frame-' + (this.previewCount) % 2);
              const newPreviewEl = document.querySelector('#preview-frame-' + (this.previewCount + 1) % 2);
              this.previewCount++;

              // If the iFrame already had content, we can just fetch the partial and replace it. This
              // prevents it from having to re-fetch the scripts and styles and stuff.
              const partial = newPreviewEl.contentDocument.querySelector('.blog-post-container') ? 'true' : 'false';

              // Fetch the preview from server
              const formData = new FormData();
              formData.append('partial', partial);

              for (const el of document.querySelectorAll('#edit-form input, #edit-form textarea')) {
                if (!el.hasAttribute('name')) {
                  continue;
                }

                formData.append(el.getAttribute('name'), el.value);
              }

              // Send the AJAX request to fetch the render HTML
              const csrfTokenHeaderName = document.body.getAttribute('data-csrf-token-header');
              const csrfToken = document.body.getAttribute('data-csrf-token');
              const resp = await fetch('/blog/render', {
                method: 'POST',
                body: formData,
                headers: { [csrfTokenHeaderName]: csrfToken }
              });
              const previewHtml = await resp.text();

              const oldScrollTop = oldPreviewEl.contentDocument.scrollingElement.scrollTop;

              if (partial === 'true') {
                // Basic swap of blog post inside already-loaded page
                newPreviewEl.contentDocument.querySelector('.blog-post-container').innerHTML = previewHtml;
                oldPreviewEl.style.display = 'none';
                newPreviewEl.style.display = 'block';
                newPreviewEl.contentDocument.scrollingElement.scrollTop = oldScrollTop;
              } else {
                // Replace entire document
                newPreviewEl.addEventListener('load', () => {
                  oldPreviewEl.style.display = 'none';
                  newPreviewEl.style.display = 'block';
                  newPreviewEl.contentDocument.scrollingElement.scrollTop = oldScrollTop;
                });
                newPreviewEl.contentWindow.document.open();
                newPreviewEl.contentWindow.document.write(previewHtml);
                newPreviewEl.contentWindow.document.close();
              }
            }, debounceMillis);
          };

          setTimeout(() => {
            if (this.hideContentEditor) {
              return;
            }

            if (this.cm) {
              this.cm.refresh();
            } else {
              const contentEl = document.querySelector('textarea[name=content]');
              this.cm = schier.setupEditor(contentEl, document.querySelector('#editor'));
              this.cm.on('change', () => update(500));
              this.cm.focus();
            }

            update(0);
          });
        }
      }
    });
  </script>
{% endblock %}
