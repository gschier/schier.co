{% extends '../../layouts/base.html' %}

{% block extraStyles %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.css">
{% endblock %}

{% block content %}
  <div class="content container">
    <h1 class="hidden-mobile">ðŸš€ Website Analytics</h1>
    <a href="?bucket=24&days=1" class="btn btn-tiny btn-gray">Today</a>
    <a href="?bucket=24&days=7" class="btn btn-tiny btn-gray">1 Week</a>
    <a href="?bucket=24&days=14" class="btn btn-tiny btn-gray">2 Weeks</a>
    <a href="?bucket=24&days=28" class="btn btn-tiny btn-gray">4 Weeks</a>
    <div class="cards cards--double-wrap">
      <div class="card">
        <div class="card__inner">
          <div class="card__title">Real-Time âœ¨</div>
          <div class="card__body card__body--big" id="live-users">0</div>
        </div>
      </div>
      <div class="card">
        <div class="card__inner">
          <div class="card__title">Time / Sess</div>
          <div class="card__body card__body--big">{{ avgSessionDuration }}</div>
        </div>
      </div>
      <div class="card">
        <div class="card__inner">
          <div class="card__title">Pages / Sess</div>
          <div class="card__body card__body--big">{{ avgPagesPerSession }}</div>
        </div>
      </div>
      <div class="card">
        <div class="card__inner">
          <div class="card__title">Bounce Rate</div>
          <div class="card__body card__body--big">{{ avgBounceRate }}</div>
        </div>
      </div>
    </div>
    <canvas id="page-views" style="height:15rem;"></canvas>
    <hr>
    <div style="display:flex;flex-wrap:wrap;justify-content:space-around">
      <canvas id="top-platforms" style="max-width:15rem;"></canvas>
      <canvas id="top-browsers" style="max-width:15rem;"></canvas>
    </div>
    <table>
      <thead>
      <tr>
        <th>Referrer</th>
        <th>Views</th>
      </tr>
      </thead>
      <tbody>
      {% for p in topRefs %}
        <tr>
          <td>
            <code style="word-break:break-all">
              {{ p.Name | truncatechars:"70" }}
            </code>
          </td>
          <td>{{ p.Count | integer }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    <table>
      <thead>
      <tr>
        <th>Page</th>
        <th>Views</th>
      </tr>
      </thead>
      <tbody>
      {% for p in topPaths %}
        <tr>
          <td>
            <a href="{{ p.Name }}" target="_blank">
              <code style="white-space:normal;word-break:break-all">
                {{ p.Name | truncatechars:"70" }}
              </code>
            </a>
          </td>
          <td>{{ p.Count | integer }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
  <script>
    const el = document.querySelector('#live-users');
    const next = async () => {
      const res = await fetch('{{ analyticsUrl }}/analytics/live');
      const data = await res.json();
      el.innerHTML = data.count;
    };
    setInterval(next, 1000 * 10);
    next();
  </script>
  <div id="data" data-bucket-size-seconds="{{ bucketSizeSeconds }}"></div>
  <script>
    const data = document.querySelector('#data');

    const colors = {
      pink: '#f687b3',
      red: '#fc8181',
      orange: '#f6ad55',
      yellow: '#f6e05e',
      green: '#68d391',
      teal: '#4fd1c5',
      blue: '#63b3ed',
      indigo: '#7f9cf5',
      purple: '#b794f4',
    };

    const bucketSize = parseInt(data.getAttribute('data-bucket-size-seconds')) * 1000;
    const pageViews = [{{ pageViews | join:', ' }}];
    const users = [{{ users | join:', ' }}];
    const sessions = [{{ sessions | join:', ' }}];

    const days = [];
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    for (let i = 0; i < pageViews.length; i++) {
      const ago = bucketSize * (pageViews.length - i - 1);
      const d = new Date(Date.now() - ago);
      days.push(`${months[d.getUTCMonth()]} ${d.getUTCDate()}`);
    }

    new Chart(document.querySelector('#page-views').getContext('2d'), {
      type: 'line',
      data: {
        labels: days,
        datasets: [{
          label: 'Users',
          data: users,
          backgroundColor: colors.blue,
          borderWidth: 1,
          borderColor: '#fff',
        }, {
          label: 'Sessions',
          data: sessions,
          backgroundColor: colors.purple,
          borderWidth: 1,
          borderColor: '#fff',
        }, {
          label: 'Views',
          data: pageViews,
          backgroundColor: colors.green,
          borderWidth: 1,
          borderColor: '#fff',
        }],
      },
      options: {
        scales: {
          xAxes: [{
            ticks: {
              maxTicksLimit: 7,
            }
          }],
          yAxes: [{
            ticks: {
              maxTicksLimit: 5,
            }
          }]
        },
      },
    });

    const pieOptions = {
      aspectRatio: 0.75,
      tooltips: {
        callbacks: {
          label: function (tooltipItem, data) {
            const rawValue = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
            const label = data.labels[tooltipItem.index];
            return ` ${label}: ${(rawValue * 100).toFixed(1)}%`;
          }
        }
      },
    };

    new Chart(document.querySelector('#top-browsers').getContext('2d'), {
      type: 'doughnut',
      options: pieOptions,
      data: {
        labels: [{% for e in topBrowsers %}'{{ e.Name }}', {% endfor %}],
        datasets: [{
          label: 'Browsers',
          data: [{% for e in topBrowsers %}'{{ e.Count }}', {% endfor %}],
          backgroundColor: Object.values(colors).reverse(),
        }],
      },
    });

    new Chart(document.querySelector('#top-platforms').getContext('2d'), {
      type: 'doughnut',
      options: pieOptions,
      data: {
        labels: [{% for e in topPlatforms %}'{{ e.Name }}', {% endfor %}],
        datasets: [{
          label: 'Operating Systems',
          data: [{% for e in topPlatforms %}'{{ e.Count }}', {% endfor %}],
          backgroundColor: Object.values(colors),
        }],
      },
    });
  </script>
{% endblock %}
